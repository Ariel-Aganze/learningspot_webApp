{% extends 'base.html' %}
{% load crispy_forms_tags %}
{% load static %}

{% block title %}Edit Quiz Questions - E-Learning Platform{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="card shadow">
        <div class="card-header bg-white">
            <div class="d-flex justify-content-between align-items-center">
                <h2 class="mb-0">Edit Questions: {{ quiz.title }}</h2>
                <div>
                    <span class="badge bg-primary me-2">Total Points: <span id="total-points">{{ total_points }}</span>/{{ max_points }}</span>
                    <a href="{% url 'quiz_detail' quiz.id %}" class="btn btn-outline-secondary btn-sm">
                        <i class="bi bi-arrow-left"></i> Back to Quiz
                    </a>
                </div>
            </div>
        </div>
        <div class="card-body">
            <form method="post" enctype="multipart/form-data">
                {% csrf_token %}
                
                {{ formset.management_form }}
                
                <div id="questions-container">
                    {% for form in formset %}
                        <div class="question-form mb-4 border rounded p-3 position-relative">
                            <div class="position-absolute top-0 end-0 p-2">
                                <div class="form-check">
                                    {{ form.DELETE }}
                                    <label class="form-check-label text-danger" for="{{ form.DELETE.id_for_label }}">
                                        Delete
                                    </label>
                                </div>
                            </div>
                            
                            <h5>Question #<span class="question-number">{{ forloop.counter }}</span></h5>
                            
                            {% if form.non_field_errors %}
                                <div class="alert alert-danger">
                                    {{ form.non_field_errors }}
                                </div>
                            {% endif %}
                            
                            {% for hidden in form.hidden_fields %}
                                {{ hidden }}
                            {% endfor %}
                            
                            <div class="row">
                                <div class="col-md-8">
                                    {{ form.text|as_crispy_field }}
                                </div>
                                <div class="col-md-4">
                                    {{ form.question_type|as_crispy_field }}
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-4">
                                    {{ form.time_limit|as_crispy_field }}
                                </div>
                                <div class="col-md-4">
                                    {{ form.points|as_crispy_field }}
                                </div>
                                <div class="col-md-4">
                                    {{ form.order|as_crispy_field }}
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    {{ form.image|as_crispy_field }}
                                </div>
                                <div class="col-md-6">
                                    {{ form.audio|as_crispy_field }}
                                </div>
                            </div>
                            
                            {% if form.instance.pk %}
                                <div class="text-center mt-2">
                                    <a href="{% url 'edit_question_choices' form.instance.pk %}" class="btn btn-info btn-sm">
                                        <i class="bi bi-list-ul"></i> Edit Choices
                                    </a>
                                </div>
                            {% else %}
                                <div class="text-center mt-2">
                                    <span class="text-muted">Save the question first to add choices</span>
                                </div>
                            {% endif %}
                        </div>
                    {% endfor %}
                </div>
                
                <div class="text-center mt-4">
                    <button type="button" id="add-question" class="btn btn-success me-2">
                        <i class="bi bi-plus-circle"></i> Add Question
                    </button>
                    <button type="submit" class="btn btn-primary">Save All Questions</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const container = document.getElementById('questions-container');
        const addButton = document.getElementById('add-question');
        const totalFormset = document.getElementById('id_form-TOTAL_FORMS');
        const maxPoints = {{ max_points }};
        
        // Function to update question numbering
        function updateQuestionNumbers() {
            document.querySelectorAll('.question-number').forEach((el, index) => {
                el.textContent = index + 1;
            });
        }
        
        // Function to calculate total points
        function calculateTotalPoints() {
            let total = 0;
            document.querySelectorAll('input[name$="-points"]').forEach(input => {
                if (!input.closest('.question-form').querySelector('input[name$="-DELETE"]').checked) {
                    total += parseInt(input.value || 0);
                }
            });
            
            const totalPointsDisplay = document.getElementById('total-points');
            totalPointsDisplay.textContent = total;
            
            // Add warning class if total doesn't match max points
            if (total !== maxPoints) {
                totalPointsDisplay.classList.add('text-danger');
                totalPointsDisplay.classList.remove('text-success');
            } else {
                totalPointsDisplay.classList.add('text-success');
                totalPointsDisplay.classList.remove('text-danger');
            }
        }
        
        // Add question button click handler
        addButton.addEventListener('click', function() {
            const forms = document.querySelectorAll('.question-form');
            const formCount = forms.length;
            
            // Clone the last form
            const lastForm = forms[formCount - 1];
            const newForm = lastForm.cloneNode(true);
            
            // Update form index
            const formRegex = new RegExp(`form-(\\d+)-`,'g');
            const replacement = `form-${formCount}-`;
            newForm.innerHTML = newForm.innerHTML.replace(formRegex, replacement);
            
            // Clear values in the new form
            newForm.querySelectorAll('input:not([type=hidden]):not([type=checkbox]), textarea').forEach(input => {
                input.value = '';
            });
            
            // Reset file inputs
            newForm.querySelectorAll('input[type=file]').forEach(input => {
                const parent = input.parentElement;
                const newInput = document.createElement('input');
                newInput.type = 'file';
                newInput.name = input.name;
                newInput.className = input.className;
                newInput.id = input.id;
                parent.replaceChild(newInput, input);
            });
            
            // Uncheck DELETE checkbox
            const deleteCheckbox = newForm.querySelector('input[name$="-DELETE"]');
            if (deleteCheckbox) {
                deleteCheckbox.checked = false;
            }
            
            // Set default values
            const pointsInput = newForm.querySelector('input[name$="-points"]');
            if (pointsInput) {
                pointsInput.value = '10';
            }

            const timeLimitInput = newForm.querySelector('input[name$="-time_limit"]');
            if (timeLimitInput) {
                timeLimitInput.value = '60';
            }
            
            const orderInput = newForm.querySelector('input[name$="-order"]');
            if (orderInput) {
                orderInput.value = formCount.toString();
            }
            
            // Add the new form to the container
            container.appendChild(newForm);
            
            // Update the total form count
            totalFormset.value = formCount + 1;
            
            // Update question numbering
            updateQuestionNumbers();
            
            // Calculate total points
            calculateTotalPoints();
        });
        
        // Add event listeners for DELETE checkboxes
        document.addEventListener('change', function(e) {
            if (e.target.name && e.target.name.endsWith('-DELETE')) {
                calculateTotalPoints();
            }
        });
        
        // Add event listeners for points inputs
        document.addEventListener('input', function(e) {
            if (e.target.name && e.target.name.endsWith('-points')) {
                calculateTotalPoints();
            }
        });
        
        // Calculate total points on page load
        calculateTotalPoints();
    });
</script>
{% endblock %}